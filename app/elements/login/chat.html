<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/firebase-element/firebase-collection.html">
<link rel="import" href="../shared-styles/shared-styles.html">
<link rel="import" href="../button/button.html">
<link rel="import" href="chat-item.html">
<dom-module is="e-chat">
    <template>
        <style>
        textarea {
            padding: 10px;
            border: none;
            border-bottom: solid 2px #c9c9c9;
            box-shadow: inset 0px 1px 23px -7px #707070;
            
            outline: 0;
            height: 100%;
            max-height: 100%;
            width: 100%;
            min-width: 100%;
            -webkit-box-sizing: border-box;
            -moz-box-sizing: border-box;
            box-sizing: border-box;

            resize: none;
          @apply(--message-text);
        }
        
        textarea:focus,
        textarea.focus {
            border-bottom: solid 2px #969696;
        }
        .layout{
            @apply(--layout-vertical);
            height: 100%;
        }
        .chat-area{
            @apply(--layout-flex);
            overflow: auto;
        }
        .text-area{
            @apply(--layout-flex);
            height: 100%;
        }
        .chatbox-area{
            @apply(--layout-horizontal);
            @apply(--layout-start);
            height: 70px;
        }
        e-button{
          background: var(--grey-rgba);
          height: 100%;
          width: 70px;
        }
textarea.error{
  border-color:red;
}
textarea.error::-webkit-input-placeholder {
   color: red;
}
textarea.error:-moz-placeholder { /* Firefox 18- */
   color: red;  
}
textarea.error::-moz-placeholder {  /* Firefox 19+ */
   color: red;  
}
textarea.error:-ms-input-placeholder {  
   color: red;  
}
        </style>
        <firebase-collection id="chat" location="https://sounak.firebaseio.com/chat" data="{{chats}}"></firebase-collection>
        <firebase-collection id="deletedChat" location="https://sounak.firebaseio.com/deletedChat"></firebase-collection>
        <div class="layout">
            <div class="chat-area">
                <template is="dom-repeat" items="{{chats}}" as="chat">
                    <e-chat-item other-style chat-item="[[chat]]" user="[[user]]" on-like="like" on-child-added="runScroll" on-remove-like="removeLike" on-remove-item="fireRemoved"></e-chat-item>
                </template>
            </div>
            <div class="chatbox-area">
                <img src="{{]}" alt="">
              <div class="text-area">
                <textarea placeholder="Write a post..." name="chatbox" on-input="validate" id="chatbox" cols="30" rows="10" value="{{chatMsg::input}}"></textarea>
              </div>
              <e-button label="Post" on-click='chatFunction'></e-button>
            </div>
        </div>
    </template>
</dom-module>
<script>
Polymer({
    is: 'e-chat',

    properties: {

        fireAdd: {
            type: String,
            value: ''
        },

        user: {
            type: Object,
            value: null
        },

        chats: {
            type: Array,
            value: function(){
              return [];
            },
            notify:true
        },


        chatMsg: {
            type: String,
            value: ''
        },

        duration:{
          type:Number,
          value:200
        }
    },
    runScroll:function(){
        this._scrollToFunction(200);
    },
    _scrollToFunction: function(duration) {
          var element = document.querySelector('.chat-area');
          if(element){
            var to = element.scrollHeight;
            if (duration <= 0){
               return;
              }
            var difference = to - element.scrollTop - element.offsetHeight;
            var perTick = difference / duration * 10;
            var comp = this;
            setTimeout(function() {
                element.scrollTop = element.scrollTop + perTick;
                if (element.scrollTop === to) {
                    return;
                }
                comp._scrollToFunction(duration - 10);
            }, 10);
          }
    },
    removeLike: function(e, data) {
        var x = this.$.chat.getByKey(data.item.__firebaseKey__);
        var query = this.$.chat.query;
        x = query.child(x.__firebaseKey__).child('likes').child(data.key);
        console.log(data);
        //if(x.child('likes').exists(this.user.uid )

        x.remove();
    },

    like: function(e) {
        var x = this.$.chat.getByKey(e.detail.__firebaseKey__);
        var query = this.$.chat.query;
        x = query.child(x.__firebaseKey__);
        //console.log(this.getByKey('full_name') )
        //if(x.child('likes').exists(this.user.uid )

        x.child('likes').push().set(this.user.uid);
    },

    //start chat
    fireRemoved: function(e) {
        console.log(e);
        this.$.deletedChat.add(e.detail);
        this.$.chat.removeByKey(e.detail.__firebaseKey__);
    },

    validate:function(){
      if (this.chatMsg.trim() ==='') {
          this.$.chatbox.classList.add('error');
        return false;
      }else{
          this.$.chatbox.classList.remove('error');
          return true;
      }
    },
    chatFunction: function() {
        if (this.validate()) {
            this.$.chat.add({
                'uid': this.user.uid,
                'msg': this.chatMsg,
                //lint error firebase not defined
                'time': Firebase.ServerValue.TIMESTAMP
            });
            this.chatMsg = '';
        }
    }
});
</script>
